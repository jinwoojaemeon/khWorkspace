package com.jdbc.lifegame.view;

import static com.jdbc.lifegame.common.UiTemplate.*;
import java.util.Scanner;
import com.jdbc.lifegame.model.vo.LifeCharacter;
import com.jdbc.lifegame.controller.LifeCharacterController;

public class ShoppingMenu {
    private LifeCharacter life;
    private Scanner sc;
    private LifeCharacterController lcc;
    
    public ShoppingMenu(LifeCharacter life, Scanner sc) {
        this.life = life;
        this.sc = sc;
        this.lcc = new LifeCharacterController();
    }
    
    public void showMenu() {
        while(true) {
            String menuName = "ì‡¼í•‘";
            menuHeader(menuName, life);
            
            System.out.println("=== ğŸ§  ì§€ëŠ¥ í–¥ìƒ ì•„ì´í…œ");
            System.out.println("1. ğŸ“š ì±… êµ¬ë§¤ - ê°€ê²©: " + formatMoney(50) + ", íš¨ê³¼: ì§€ëŠ¥ +1");
            System.out.println("2. ğŸ’» ì»´í“¨í„° êµ¬ë§¤ - ê°€ê²©: " + formatMoney(500) + ", íš¨ê³¼: ì§€ëŠ¥ +5");
            System.out.println("3. ğŸ“± ìµœì‹  ìŠ¤ë§ˆíŠ¸í° - ê°€ê²©: " + formatMoney(200) + ", íš¨ê³¼: ì§€ëŠ¥ +2");
            
            System.out.println();
            System.out.println("=== ğŸ’ª ì²´ë ¥ íšŒë³µ ì•„ì´í…œ");
            System.out.println("4. ğŸ ê±´ê°•ì‹í’ˆ - ê°€ê²©: " + formatMoney(30) + ", íš¨ê³¼: ì²´ë ¥ +2");
            System.out.println("5. ğŸ’Š ì˜ì–‘ì œ - ê°€ê²©: " + formatMoney(100) + ", íš¨ê³¼: ì²´ë ¥ +5");
            System.out.println("6. ğŸ¥ ì¢…í•©ê±´ê°•ê²€ì§„ - ê°€ê²©: " + formatMoney(300) + ", íš¨ê³¼: ì²´ë ¥ +10");
            
            System.out.println();
            System.out.println("=== ğŸ€ ìš´ í–¥ìƒ ì•„ì´í…œ");
            System.out.println("7. ğŸ§¿ í–‰ìš´ì˜ ë¶€ì  - ê°€ê²©: " + formatMoney(80) + ", íš¨ê³¼: ìš´ +2");
            System.out.println("8. ğŸ’ í–‰ìš´ì„ - ê°€ê²©: " + formatMoney(250) + ", íš¨ê³¼: ìš´ +5");
            
            System.out.println();
            System.out.println("=== ğŸ íŠ¹ë³„ ì•„ì´í…œ");
            System.out.println("9. âš¡ ì—ë„ˆì§€ ë“œë§í¬ - ê°€ê²©: " + formatMoney(20) + ", íš¨ê³¼: ì²´ë ¥ +1, ì§€ëŠ¥ +1");
            System.out.println("10. ğŸ¯ ìê¸°ê³„ë°œì„œ ì„¸íŠ¸ - ê°€ê²©: " + formatMoney(150) + ", íš¨ê³¼: ì§€ëŠ¥ +3, ìš´ +1");
            System.out.println("11. ğŸƒâ€â™‚ï¸ ìš´ë™ìš©í’ˆ ì„¸íŠ¸ - ê°€ê²©: " + formatMoney(120) + ", íš¨ê³¼: ì²´ë ¥ +3, ìš´ +1");
            
            System.out.println();
            System.out.println("0. â† ëŒì•„ê°€ê¸°");
            line();
            System.out.print("ë©”ë‰´ ì„ íƒ: ");
            
            int sel = sc.nextInt();
            sc.nextLine();
            System.out.println("\n");
            
            switch(sel) {
                case 1: buyItem("ì±…", 50, 1, 0, 0); break;
                case 2: buyItem("ì»´í“¨í„°", 500, 5, 0, 0); break;
                case 3: buyItem("ìµœì‹  ìŠ¤ë§ˆíŠ¸í°", 200, 2, 0, 0); break;
                case 4: buyItem("ê±´ê°•ì‹í’ˆ", 30, 0, 2, 0); break;
                case 5: buyItem("ì˜ì–‘ì œ", 100, 0, 5, 0); break;
                case 6: buyItem("ì¢…í•©ê±´ê°•ê²€ì§„", 300, 0, 10, 0); break;
                case 7: buyItem("í–‰ìš´ì˜ ë¶€ì ", 80, 0, 0, 2); break;
                case 8: buyItem("í–‰ìš´ì„", 250, 0, 0, 5); break;
                case 9: buyItem("ì—ë„ˆì§€ ë“œë§í¬", 20, 1, 1, 0); break;
                case 10: buyItem("ìê¸°ê³„ë°œì„œ ì„¸íŠ¸", 150, 3, 0, 1); break;
                case 11: buyItem("ìš´ë™ìš©í’ˆ ì„¸íŠ¸", 120, 0, 3, 1); break;
                case 0: return;
                default: System.out.println("ì˜ëª»ëœ ì…ë ¥ì…ë‹ˆë‹¤.");
            }
            
            if(sel != 0) {
                System.out.println("Enter í‚¤ë¥¼ ëˆŒëŸ¬ ê³„ì†í•˜ì„¸ìš”...");
                sc.nextLine();
            }
        }
    }
    
    private void buyItem(String itemName, int price, int intBonus, int stamBonus, int luckBonus) {
        System.out.println("\n=== " + itemName + " êµ¬ë§¤ ===");
        System.out.println("ê°€ê²©: " + formatMoney(price));
        System.out.println("í˜„ì¬ ìê¸ˆ: " + formatMoney(life.getMoney()));
        
        // íš¨ê³¼ í‘œì‹œ
        StringBuilder effects = new StringBuilder("íš¨ê³¼: ");
        boolean hasEffect = false;
        
        if(intBonus > 0) {
            effects.append("ì§€ëŠ¥ +").append(intBonus);
            hasEffect = true;
        }
        if(stamBonus > 0) {
            if(hasEffect) effects.append(", ");
            effects.append("ì²´ë ¥ +").append(stamBonus);
            hasEffect = true;
        }
        if(luckBonus > 0) {
            if(hasEffect) effects.append(", ");
            effects.append("ìš´ +").append(luckBonus);
        }
        
        System.out.println(effects.toString());
        
        // ìê¸ˆ í™•ì¸
        if(life.getMoney() < price) {
            System.out.printf("ìê¸ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤. (í•„ìš”: %s, ë³´ìœ : %s)\n", 
                            formatMoney(price), formatMoney(life.getMoney()));
            return;
        }
        
        // ëŠ¥ë ¥ì¹˜ ë³€í™” ì „ ê°’ ì €ì¥
        int prevInt = life.getIntelligence();
        int prevStam = life.getStamina();
        int prevLuck = life.getLuck();
        
        // êµ¬ë§¤ ì‹¤í–‰
        life.setMoney(life.getMoney() - price);
        life.setIntelligence(life.getIntelligence() + intBonus);
        life.setStamina(life.getStamina() + stamBonus);
        life.setLuck(life.getLuck() + luckBonus);
        
        // ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸ (ì‡¼í•‘ ì „ìš©)
        lcc.updateShopping(life);
        
        // êµ¬ë§¤ ì™„ë£Œ ë©”ì‹œì§€
        line();
        System.out.println("ğŸ‰ " + itemName + "ì„(ë¥¼) ì„±ê³µì ìœ¼ë¡œ êµ¬ë§¤í–ˆìŠµë‹ˆë‹¤!");
        System.out.println("ì§€ì¶œ: " + formatMoney(price));
        
        // ëŠ¥ë ¥ì¹˜ ë³€í™” í‘œì‹œ
        if(intBonus > 0) {
            System.out.println("ì§€ëŠ¥: " + prevInt + " â†’ " + life.getIntelligence() + " (+" + intBonus + ")");
        }
        if(stamBonus > 0) {
            System.out.println("ì²´ë ¥: " + prevStam + " â†’ " + life.getStamina() + " (+" + stamBonus + ")");
        }
        if(luckBonus > 0) {
            System.out.println("ìš´: " + prevLuck + " â†’ " + life.getLuck() + " (+" + luckBonus + ")");
        }
        
        System.out.println("ë‚¨ì€ ìê¸ˆ: " + formatMoney(life.getMoney()));
        line();
        
        // êµ¬ë§¤ ì™„ë£Œ í›„ ì ê¹ ë”œë ˆì´
        try {
            Thread.sleep(800);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
    
    private void buyLotto(String itemName, int price) {
        System.out.println("\n=== ğŸ° ë¡œë˜ êµ¬ë§¤ ===");
        System.out.println("ê°€ê²©: " + formatMoney(price));
        System.out.println("í˜„ì¬ ìê¸ˆ: " + formatMoney(life.getMoney()));
        System.out.println("ğŸ’¡ ë‹¹ì²¨ í™•ë¥ ì€ ìš´ ëŠ¥ë ¥ì¹˜ì— ë¹„ë¡€í•©ë‹ˆë‹¤!");
        System.out.println("í˜„ì¬ ìš´ ëŠ¥ë ¥ì¹˜: " + life.getLuck());
        
        // ìê¸ˆ í™•ì¸
        if(life.getMoney() < price) {
            System.out.printf("ìê¸ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤. (í•„ìš”: %s, ë³´ìœ : %s)\n", 
                            formatMoney(price), formatMoney(life.getMoney()));
            return;
        }
        
        // êµ¬ë§¤ í™•ì¸
        System.out.print("ë¡œë˜ë¥¼ êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): ");
        String confirm = sc.nextLine().trim().toLowerCase();
        
        if(!confirm.equals("y") && !confirm.equals("yes")) {
            System.out.println("êµ¬ë§¤ë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.");
            return;
        }
        
        // ë¡œë˜ êµ¬ë§¤
        life.setMoney(life.getMoney() - price);
        
        System.out.println("\nğŸ² ì¶”ì²¨ ì¤‘ì…ë‹ˆë‹¤...");
        
        // ì¶”ì²¨ ì—°ì¶œ
        try {
            for(int i = 0; i < 3; i++) {
                Thread.sleep(500);
                System.out.print(".");
            }
            Thread.sleep(500);
            System.out.println("\n");
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        
        // ë‹¹ì²¨ í™•ë¥  ê³„ì‚° (ìš´ ëŠ¥ë ¥ì¹˜ ê¸°ë°˜)
        // ê¸°ë³¸ í™•ë¥  5% + (ìš´ ëŠ¥ë ¥ì¹˜ Ã— 0.5%)
        double winChance = 0.05 + (life.getLuck() * 0.005);
        double randomValue = Math.random();
        
        if(randomValue < winChance) {
            // ë‹¹ì²¨! ìƒê¸ˆ ê³„ì‚°
            int[] prizes = {5000, 10000, 25000, 50000, 100000}; // 5ì²œë§Œì› ~ 10ì–µì›
            double[] prizeChances = {0.6, 0.25, 0.1, 0.04, 0.01}; // í™•ë¥  ë¶„ë°°
            
            int wonPrize = selectPrize(prizes, prizeChances);
            life.setMoney(life.getMoney() + wonPrize);
            
            line();
            System.out.println("ğŸ‰ğŸ‰ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ë‹¹ì²¨ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰ğŸ‰ğŸ‰");
            System.out.println("ğŸ’° ë‹¹ì²¨ê¸ˆ: " + formatMoney(wonPrize));
            System.out.println("ğŸ’¸ ìˆœì´ìµ: " + formatMoney(wonPrize - price));
            System.out.println("ğŸ’µ í˜„ì¬ ìê¸ˆ: " + formatMoney(life.getMoney()));
            line();
            
            // ë‹¹ì²¨ ì‹œ ìš´ ëŠ¥ë ¥ì¹˜ ì†Œí­ ì¦ê°€ (í–‰ìš´ì´ í–‰ìš´ì„ ë¶€ë¥¸ë‹¤!)
            if(Math.random() < 0.3) { // 30% í™•ë¥ 
                life.setLuck(life.getLuck() + 1);
                System.out.println("ğŸ€ í–‰ìš´ì´ í–‰ìš´ì„ ë¶ˆë €ìŠµë‹ˆë‹¤! ìš´ +1");
            }
            
        } else {
            // ê½
            System.out.println("ğŸ’” ì•„ì‰½ê²Œë„ ê½ì…ë‹ˆë‹¤...");
            System.out.println("ğŸ’¸ ì†ì‹¤: " + formatMoney(price));
            System.out.println("ğŸ’µ í˜„ì¬ ìê¸ˆ: " + formatMoney(life.getMoney()));
            
            // ê½ì¼ ë•Œë„ ì•„ì£¼ ë‚®ì€ í™•ë¥ ë¡œ ìš´ ì¦ê°€ (ê²½í—˜ì¹˜ ê°œë…)
            if(Math.random() < 0.05) { // 5% í™•ë¥ 
                life.setLuck(life.getLuck() + 1);
                System.out.println("ğŸ€ ë¹„ë¡ ê½ì´ì§€ë§Œ ê²½í—˜ì´ ìŒ“ì˜€ìŠµë‹ˆë‹¤! ìš´ +1");
            }
        }
        
        // ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸
        lcc.updateRealEstate(life);
        
        // ë”œë ˆì´
        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
    
    // ìƒê¸ˆ ì„ íƒ ë©”ì„œë“œ
    private int selectPrize(int[] prizes, double[] chances) {
        double random = Math.random();
        double cumulative = 0.0;
        
        for(int i = 0; i < prizes.length; i++) {
            cumulative += chances[i];
            if(random <= cumulative) {
                return prizes[i];
            }
        }
        return prizes[0]; // ê¸°ë³¸ê°’
    }
}